{"version":3,"file":"object-model.min.js","sources":["../src/helpers.js","../src/object-model.js","../src/list-model.js","../src/array-model.js","../src/function-model.js","../src/map-model.js","../src/set-model.js"],"sourcesContent":["export const\n\tbettertypeof = x => Object.prototype.toString.call(x).match(/\\s([a-zA-Z]+)/)[1],\n\tgetProto = Object.getPrototypeOf,\n\tsetProto = Object.setPrototypeOf,\n\n\thas = (o, prop) => o.hasOwnProperty(prop),\n\tis = (Constructor, obj) => obj instanceof Constructor,\n\tisFunction = f => typeof f === \"function\",\n\tisObject = o => typeof o === \"object\",\n\tisPlainObject = o => o && isObject(o) && getProto(o) === Object.prototype,\n\tisIterable = x => x && isFunction(x[Symbol.iterator]),\n\n\tproxifyFn = (fn, apply) => new Proxy(fn, { apply }),\n\tproxifyModel = (val, model, traps) => new Proxy(val, Object.assign({ getPrototypeOf: () => model.prototype }, traps)),\n\n\tmerge = (target, src = {}) => {\n\t\tfor (let key in src) {\n\t\t\tif (isPlainObject(src[key])) {\n\t\t\t\tlet o = {}\n\t\t\t\tmerge(o, target[key])\n\t\t\t\tmerge(o, src[key])\n\t\t\t\ttarget[key] = o\n\t\t\t} else {\n\t\t\t\ttarget[key] = src[key]\n\t\t\t}\n\t\t}\n\t\treturn target\n\t},\n\n\tdefine = (obj, key, value, enumerable = false) => {\n\t\tObject.defineProperty(obj, key, { value, enumerable, writable: true, configurable: true })\n\t},\n\n\tsetConstructor = (model, constructor) => {\n\t\tsetProto(model, constructor.prototype)\n\t\tdefine(model, \"constructor\", constructor)\n\t},\n\n\textend = (child, parent, props) => {\n\t\tchild.prototype = Object.assign(Object.create(parent.prototype, {\n\t\t\tconstructor: {\n\t\t\t\tvalue: child,\n\t\t\t\twritable: true,\n\t\t\t\tconfigurable: true\n\t\t\t}\n\t\t}), props)\n\t\tsetProto(child, parent)\n\t}","import {\n\tbettertypeof, define, extend, getProto, has, is, isFunction, isObject, isPlainObject,\n\tmerge, proxifyFn, setConstructor\n} from \"./helpers.js\"\n\nexport const\n\t_check = Symbol(),\n\t_validate = Symbol(),\n\t_original = Symbol(), // used to bypass proxy\n\n\tSKIP_VALIDATE = Symbol(), // used to skip validation at instanciation for perf\n\n\tinitModel = (model, constructor, def) => {\n\t\tsetConstructor(model, constructor)\n\t\tmodel.definition = def\n\t\tmodel.assertions = [...model.assertions]\n\t\tdefine(model, \"errors\", [])\n\t\tdelete model.name\n\t\treturn model\n\t},\n\n\textendModel = (child, parent, newProps) => {\n\t\textend(child, parent, newProps)\n\t\tchild.assertions.push(...parent.assertions)\n\t\treturn child\n\t},\n\n\tstackError = (errors, expected, received, path, message) => {\n\t\terrors.push({ expected, received, path, message })\n\t},\n\n\tunstackErrors = (model, collector = model.errorCollector) => {\n\t\tlet nbErrors = model.errors.length\n\t\tif (nbErrors > 0) {\n\t\t\tlet errors = model.errors.map(err => {\n\t\t\t\tif (!err.message) {\n\t\t\t\t\tlet def = [].concat(err.expected)\n\t\t\t\t\terr.message = \"expecting \" + (err.path ? err.path + \" to be \" : \"\") + def.map(d => format(d)).join(\" or \")\n\t\t\t\t\t\t+ \", got \" + (err.received != null ? bettertypeof(err.received) + \" \" : \"\") + format(err.received)\n\t\t\t\t}\n\t\t\t\treturn err\n\t\t\t})\n\n\t\t\tmodel.errors.length = 0\n\t\t\tcollector.call(model, errors) // throw all errors collected\n\t\t}\n\t\treturn nbErrors\n\t},\n\n\tisModelInstance = i => i && getProto(i) && is(Model, getProto(i).constructor),\n\n\tparseDefinition = (def) => {\n\t\tif (isPlainObject(def)) {\n\t\t\tObject.keys(def).map(key => { def[key] = parseDefinition(def[key]) })\n\t\t}\n\t\telse if (!Array.isArray(def)) return [def]\n\t\telse if (def.length === 1) return [...def, undefined, null]\n\n\t\treturn def\n\t},\n\n\tformatDefinition = (def, stack) => {\n\t\tlet parts = parseDefinition(def).map(d => format(d, stack))\n\t\treturn parts.length > 1 ? `(${parts.join(\" or \")})` : parts[0]\n\t},\n\n\textendDefinition = (def, newParts = []) => {\n\t\tnewParts = [].concat(newParts)\n\t\tif (newParts.length > 0) {\n\t\t\tdef = newParts\n\t\t\t\t.reduce((def, ext) => def.concat(ext), [].concat(def)) // clone to lose ref\n\t\t\t\t.filter((value, index, self) => self.indexOf(value) === index) // remove duplicates\n\t\t}\n\n\t\treturn def\n\t},\n\n\tcheckDefinition = (obj, def, path, errors, stack, shouldCast) => {\n\t\tlet indexFound = stack.indexOf(def)\n\t\tif (indexFound !== -1 && stack.indexOf(def, indexFound + 1) !== -1)\n\t\t\treturn obj // if found twice in call stack, cycle detected, skip validation\n\n\t\tif (is(Model, def)) {\n\t\t\tif (shouldCast) obj = cast(obj, def)\n\t\t\tdef[_check](obj, path, errors, stack.concat(def))\n\t\t}\n\t\telse if (isPlainObject(def)) {\n\t\t\tObject.keys(def).map(key => {\n\t\t\t\tlet val = obj ? obj[key] : undefined\n\t\t\t\tcheckDefinition(val, def[key], formatPath(path, key), errors, stack, shouldCast)\n\t\t\t})\n\t\t}\n\t\telse {\n\t\t\tlet pdef = parseDefinition(def)\n\t\t\tif (pdef.some(part => checkDefinitionPart(obj, part, path, stack))) {\n\t\t\t\tif (shouldCast) obj = cast(obj, def)\n\t\t\t\treturn obj\n\t\t\t}\n\n\t\t\tstackError(errors, def, obj, path)\n\t\t}\n\n\t\treturn obj\n\t},\n\n\tcheckDefinitionPart = (obj, def, path, stack, shouldCast) => {\n\t\tif (obj == null) return obj === def\n\t\tif (isPlainObject(def) || is(Model, def)) { // object or model as part of union type\n\t\t\tlet errors = []\n\t\t\tcheckDefinition(obj, def, path, errors, stack, shouldCast)\n\t\t\treturn !errors.length\n\t\t}\n\t\tif (is(RegExp, def)) return def.test(obj)\n\t\tif (def === Number || def === Date) return obj.constructor === def && !isNaN(obj)\n\t\treturn obj === def\n\t\t\t|| (isFunction(def) && is(def, obj))\n\t\t\t|| obj.constructor === def\n\t},\n\n\tcheckAssertions = (obj, model, path, errors = model.errors) => {\n\t\tfor (let assertion of model.assertions) {\n\t\t\tlet result\n\t\t\ttry {\n\t\t\t\tresult = assertion.call(model, obj)\n\t\t\t} catch (err) {\n\t\t\t\tresult = err\n\t\t\t}\n\t\t\tif (result !== true) {\n\t\t\t\tlet onFail = isFunction(assertion.description) ? assertion.description : (assertionResult, value) =>\n\t\t\t\t\t`assertion \"${assertion.description}\" returned ${format(assertionResult)} `\n\t\t\t\t\t+ `for ${path ? path + \" =\" : \"value\"} ${format(value)}`\n\t\t\t\tstackError(errors, assertion, obj, path, onFail.call(model, result, obj, path))\n\t\t\t}\n\t\t}\n\t},\n\n\tformat = (obj, stack = []) => {\n\t\tif (stack.length > 15 || stack.includes(obj)) return '...'\n\t\tif (obj === null || obj === undefined) return String(obj)\n\t\tif (typeof obj === \"string\") return `\"${obj}\"`\n\t\tif (is(Model, obj)) return obj.toString(stack)\n\n\t\tstack.unshift(obj)\n\n\t\tif (isFunction(obj)) return obj.name || obj.toString()\n\t\tif (is(Map, obj) || is(Set, obj)) return format([...obj])\n\t\tif (Array.isArray(obj)) return `[${obj.map(item => format(item, stack)).join(', ')}]`\n\t\tif (obj.toString !== Object.prototype.toString) return obj.toString()\n\t\tif (obj && isObject(obj)) {\n\t\t\tlet props = Object.keys(obj),\n\t\t\t\tindent = '\\t'.repeat(stack.length)\n\t\t\treturn `{${props.map(\n\t\t\t\tkey => `\\n${indent + key}: ${format(obj[key], [...stack])}`\n\t\t\t).join(',')} ${props.length ? `\\n${indent.slice(1)}` : ''}}`\n\t\t}\n\n\t\treturn String(obj)\n\t},\n\n\tformatPath = (path, key) => path ? path + '.' + key : key,\n\n\tcontrolMutation = (model, def, path, o, key, privateAccess, applyMutation) => {\n\t\tlet newPath = formatPath(path, key),\n\t\t\tisPrivate = model.conventionForPrivate(key),\n\t\t\tisConstant = model.conventionForConstant(key),\n\t\t\tisOwnProperty = has(o, key),\n\t\t\tinitialPropDescriptor = isOwnProperty && Object.getOwnPropertyDescriptor(o, key)\n\n\t\tif (key in def && ((isPrivate && !privateAccess) || (isConstant && o[key] !== undefined)))\n\t\t\tcannot(`modify ${isPrivate ? \"private\" : \"constant\"} property ${key}`, model)\n\n\t\tapplyMutation(newPath)\n\t\tif (has(def, key)) checkDefinition(o[key], def[key], newPath, model.errors, [])\n\t\tcheckAssertions(o, model, newPath)\n\n\t\tlet nbErrors = model.errors.length\n\t\tif (nbErrors) {\n\t\t\tif (isOwnProperty) Object.defineProperty(o, key, initialPropDescriptor)\n\t\t\telse delete o[key] // back to the initial property defined in prototype chain\n\n\t\t\tunstackErrors(model)\n\t\t}\n\n\t\treturn !nbErrors\n\t},\n\n\tcannot = (msg, model) => {\n\t\tmodel.errors.push({ message: \"cannot \" + msg })\n\t},\n\n\tcast = (obj, defNode = []) => {\n\t\tif (!obj || isPlainObject(defNode) || is(BasicModel, defNode) || isModelInstance(obj))\n\t\t\treturn obj // no value or not leaf or already a model instance\n\n\t\tlet def = parseDefinition(defNode),\n\t\t\tsuitableModels = []\n\n\t\tfor (let part of def) {\n\t\t\tif (is(Model, part) && !is(BasicModel, part) && part.test(obj))\n\t\t\t\tsuitableModels.push(part)\n\t\t}\n\n\t\tif (suitableModels.length === 1) {\n\t\t\t// automatically cast to suitable model when explicit (autocasting)\n\t\t\treturn new suitableModels[0](obj, SKIP_VALIDATE)\n\t\t}\n\n\t\tif (suitableModels.length > 1)\n\t\t\tconsole.warn(`Ambiguous model for value ${format(obj)}, could be ${suitableModels.join(\" or \")}`)\n\n\t\treturn obj\n\t},\n\n\tgetProxy = (model, obj, def, path, privateAccess) => {\n\t\tif (!isPlainObject(def)) return cast(obj, def)\n\n\t\tconst grantPrivateAccess = f => proxifyFn(f, (fn, ctx, args) => {\n\t\t\tprivateAccess = true\n\t\t\tlet result = Reflect.apply(fn, ctx, args)\n\t\t\tprivateAccess = false\n\t\t\treturn result\n\t\t})\n\n\t\treturn new Proxy(obj, {\n\n\t\t\tgetPrototypeOf: () => path ? Object.prototype : getProto(obj),\n\n\t\t\tget(o, key) {\n\t\t\t\tif (key === _original) return o\n\n\t\t\t\tif (typeof key !== \"string\") return Reflect.get(o, key)\n\n\t\t\t\tlet newPath = formatPath(path, key),\n\t\t\t\t\tdefPart = def[key]\n\n\t\t\t\tif (!privateAccess && key in def && model.conventionForPrivate(key)) {\n\t\t\t\t\tcannot(`access to private property ${newPath}`, model)\n\t\t\t\t\tunstackErrors(model)\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tif (o[key] && has(o, key) && !isPlainObject(defPart) && !isModelInstance(o[key])) {\n\t\t\t\t\to[key] = cast(o[key], defPart) // cast nested models\n\t\t\t\t}\n\n\t\t\t\tif (isFunction(o[key]) && key !== \"constructor\" && !privateAccess) {\n\t\t\t\t\treturn grantPrivateAccess(o[key])\n\t\t\t\t}\n\n\t\t\t\tif (isPlainObject(defPart) && !o[key]) {\n\t\t\t\t\to[key] = {} // null-safe traversal\n\t\t\t\t}\n\n\t\t\t\treturn getProxy(model, o[key], defPart, newPath, privateAccess)\n\t\t\t},\n\n\t\t\tset(o, key, val) {\n\t\t\t\treturn controlMutation(model, def, path, o, key, privateAccess,\n\t\t\t\t\tnewPath => Reflect.set(o, key, getProxy(model, val, def[key], newPath))\n\t\t\t\t)\n\t\t\t},\n\n\t\t\tdeleteProperty(o, key) {\n\t\t\t\treturn controlMutation(model, def, path, o, key, privateAccess, () => Reflect.deleteProperty(o, key))\n\t\t\t},\n\n\t\t\tdefineProperty(o, key, args) {\n\t\t\t\treturn controlMutation(model, def, path, o, key, privateAccess, () => Reflect.defineProperty(o, key, args))\n\t\t\t},\n\n\t\t\thas(o, key) {\n\t\t\t\treturn Reflect.has(o, key) && Reflect.has(def, key) && !model.conventionForPrivate(key)\n\t\t\t},\n\n\t\t\townKeys(o) {\n\t\t\t\treturn Reflect.ownKeys(o).filter(key => Reflect.has(def, key) && !model.conventionForPrivate(key))\n\t\t\t},\n\n\t\t\tgetOwnPropertyDescriptor(o, key) {\n\t\t\t\tlet descriptor\n\t\t\t\tif (!model.conventionForPrivate(key)) {\n\t\t\t\t\tdescriptor = Object.getOwnPropertyDescriptor(def, key)\n\t\t\t\t\tif (descriptor !== undefined) descriptor.value = o[key]\n\t\t\t\t}\n\n\t\t\t\treturn descriptor\n\t\t\t}\n\t\t})\n\t}\n\n\nexport function Model(def, params) {\n\treturn isPlainObject(def) ? new ObjectModel(def, params) : new BasicModel(def)\n}\n\nObject.assign(Model.prototype, {\n\tname: \"Model\",\n\tassertions: [],\n\n\tconventionForConstant: key => key.toUpperCase() === key,\n\tconventionForPrivate: key => key[0] === \"_\",\n\n\ttoString(stack) {\n\t\treturn formatDefinition(this.definition, stack)\n\t},\n\n\tas(name) {\n\t\tdefine(this, \"name\", name)\n\t\treturn this\n\t},\n\n\tdefaultTo(val) {\n\t\tthis.default = val\n\t\treturn this\n\t},\n\n\t[_check](obj, path, errors, stack) {\n\t\tcheckDefinition(obj, this.definition, path, errors, stack)\n\t\tcheckAssertions(obj, this, path, errors)\n\t},\n\n\t[_validate](obj) {\n\t\tthis[_check](obj, null, this.errors, [], true);\n\t\treturn !unstackErrors(this)\n\t},\n\n\ttest(obj, errorCollector) {\n\t\tlet model = this\n\t\twhile (!has(model, \"errorCollector\")) {\n\t\t\tmodel = getProto(model)\n\t\t}\n\n\t\tlet initialErrorCollector = model.errorCollector,\n\t\t\tfailed\n\n\t\tmodel.errorCollector = errors => {\n\t\t\tfailed = true\n\t\t\tif (errorCollector) errorCollector.call(this, errors)\n\t\t}\n\n\t\tnew this(obj) // may trigger errorCollector\n\n\t\tmodel.errorCollector = initialErrorCollector\n\t\treturn !failed\n\t},\n\n\terrorCollector(errors) {\n\t\tlet e = new TypeError(errors.map(e => e.message).join('\\n'))\n\t\te.stack = e.stack.replace(/\\n.*object-model(.|\\n)*object-model.*/, \"\") // blackbox objectmodel in stacktrace\n\t\tthrow e\n\t},\n\n\tassert(assertion, description = format(assertion)) {\n\t\tdefine(assertion, \"description\", description)\n\t\tthis.assertions = this.assertions.concat(assertion)\n\t\treturn this\n\t}\n})\n\n\nexport function BasicModel(def) {\n\tlet model = function (val = model.default) {\n\t\treturn model[_validate](val) ? val : undefined\n\t}\n\n\treturn initModel(model, BasicModel, def)\n}\n\nextend(BasicModel, Model, {\n\textend(...newParts) {\n\t\tlet child = extendModel(new BasicModel(extendDefinition(this.definition, newParts)), this)\n\t\tfor (let part of newParts) {\n\t\t\tif (is(BasicModel, part)) child.assertions.push(...part.assertions)\n\t\t}\n\n\t\treturn child\n\t}\n})\n\n\nexport function ObjectModel(def) {\n\tlet model = function (obj, mode) {\n\t\tif (!is(model, this)) return new model(obj)\n\t\tif (is(model, obj)) return obj\n\n\t\tif (obj === null || (!isObject(obj) && !isFunction(obj) && obj !== undefined)) {\n\t\t\tstackError(model.errors, Object, obj)\n\t\t}\n\n\t\tmerge(this, model.default)\n\t\tif (model.parentClass) merge(obj, new model.parentClass(obj))\n\t\tmerge(this, obj)\n\n\t\tif (mode !== SKIP_VALIDATE) model[_validate](this)\n\n\t\treturn getProxy(model, this, model.definition)\n\t}\n\n\textend(model, Object)\n\treturn initModel(model, ObjectModel, def)\n}\n\nextend(ObjectModel, Model, {\n\tdefaultTo(obj) {\n\t\tlet def = this.definition\n\t\tfor (let key in obj) {\n\t\t\tif (has(def, key)) {\n\t\t\t\tobj[key] = checkDefinition(obj[key], def[key], key, this.errors, [], true)\n\t\t\t}\n\t\t}\n\t\tunstackErrors(this)\n\t\tthis.default = obj;\n\t\treturn this\n\t},\n\n\ttoString(stack) {\n\t\treturn format(this.definition, stack)\n\t},\n\n\textend(...newParts) {\n\t\tlet definition = { ...this.definition },\n\t\t\tproto = { ...this.prototype },\n\t\t\tdefaults = { ...this.default },\n\t\t\tnewAssertions = []\n\n\t\tfor (let part of newParts) {\n\t\t\tif (is(Model, part)) {\n\t\t\t\tmerge(definition, part.definition)\n\t\t\t\tmerge(defaults, part.default)\n\t\t\t\tnewAssertions.push(...part.assertions)\n\t\t\t}\n\t\t\tif (isFunction(part)) merge(proto, part.prototype)\n\t\t\tif (isObject(part)) merge(definition, part)\n\t\t}\n\n\t\tlet submodel = extendModel(new ObjectModel(definition), this, proto).defaultTo(defaults)\n\t\tsubmodel.assertions = [...this.assertions, ...newAssertions]\n\n\t\tif (getProto(this) !== ObjectModel.prototype) { // extended class\n\t\t\tsubmodel.parentClass = this\n\t\t}\n\n\t\treturn submodel\n\t},\n\n\t[_check](obj, path, errors, stack, shouldCast) {\n\t\tif (isObject(obj)) {\n\t\t\tlet def = this.definition\n\t\t\tcheckDefinition(obj[_original] || obj, def, path, errors, stack, shouldCast)\n\t\t}\n\t\telse stackError(errors, this, obj, path)\n\n\t\tcheckAssertions(obj, this, path, errors)\n\t}\n})","import { _original, _validate, checkAssertions, checkDefinition, initModel, unstackErrors, SKIP_VALIDATE } from \"./object-model.js\"\nimport { has, isFunction, proxifyFn, proxifyModel, extend } from \"./helpers.js\"\n\nexport const initListModel = (base, constructor, def, init, clone, mutators, otherTraps = {}) => {\n\n\tlet model = function (list = model.default, mode) {\n\t\tlist = init(list)\n\n\t\tif (mode === SKIP_VALIDATE || model[_validate](list)) {\n\t\t\treturn proxifyModel(list, model, Object.assign({\n\t\t\t\tget(l, key) {\n\t\t\t\t\tif (key === _original) return l\n\n\t\t\t\t\tlet val = l[key]\n\t\t\t\t\treturn isFunction(val) ? proxifyFn(val, (fn, ctx, args) => {\n\t\t\t\t\t\tif (has(mutators, key)) {\n\t\t\t\t\t\t\t// indexes of arguments to check def + cast\n\t\t\t\t\t\t\tlet [begin, end = args.length - 1, getArgDef] = mutators[key]\n\t\t\t\t\t\t\tfor (let i = begin; i <= end; i++) {\n\t\t\t\t\t\t\t\tlet argDef = getArgDef ? getArgDef(i) : model.definition\n\t\t\t\t\t\t\t\targs[i] = checkDefinition(\n\t\t\t\t\t\t\t\t\targs[i],\n\t\t\t\t\t\t\t\t\targDef,\n\t\t\t\t\t\t\t\t\t`${base.name}.${key} arguments[${i}]`,\n\t\t\t\t\t\t\t\t\tmodel.errors,\n\t\t\t\t\t\t\t\t\t[],\n\t\t\t\t\t\t\t\t\ttrue\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (model.assertions.length > 0) {\n\t\t\t\t\t\t\t\tlet testingClone = clone(l)\n\t\t\t\t\t\t\t\tfn.apply(testingClone, args)\n\t\t\t\t\t\t\t\tcheckAssertions(testingClone, model, `after ${key} mutation`)\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tunstackErrors(model)\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn fn.apply(l, args)\n\t\t\t\t\t}) : val\n\t\t\t\t}\n\t\t\t}, otherTraps))\n\t\t}\n\t}\n\n\textend(model, base)\n\treturn initModel(model, constructor, def)\n}","import {\n\t_original, _check, cast, checkAssertions, checkDefinition,\n\textendDefinition, extendModel, formatDefinition, Model, stackError, unstackErrors\n} from \"./object-model.js\"\nimport { extend } from \"./helpers.js\"\nimport { initListModel } from \"./list-model.js\"\n\nexport default function ArrayModel(initialDefinition) {\n\tlet model = initListModel(\n\t\tArray,\n\t\tArrayModel,\n\t\tinitialDefinition,\n\t\ta => Array.isArray(a) ? a.map(arg => cast(arg, model.definition)) : a,\n\t\ta => [...a],\n\t\t{\n\t\t\t\"copyWithin\": [],\n\t\t\t\"fill\": [0, 0],\n\t\t\t\"pop\": [],\n\t\t\t\"push\": [0],\n\t\t\t\"reverse\": [],\n\t\t\t\"shift\": [],\n\t\t\t\"sort\": [],\n\t\t\t\"splice\": [2],\n\t\t\t\"unshift\": [0]\n\t\t},\n\t\t{\n\t\t\tset(arr, key, val) {\n\t\t\t\treturn controlMutation(model, arr, key, val, (a, v) => a[key] = v, true)\n\t\t\t},\n\n\t\t\tdeleteProperty(arr, key) {\n\t\t\t\treturn controlMutation(model, arr, key, undefined, a => delete a[key])\n\t\t\t}\n\t\t}\n\t)\n\n\treturn model\n}\n\nextend(ArrayModel, Model, {\n\ttoString(stack) {\n\t\treturn 'Array of ' + formatDefinition(this.definition, stack)\n\t},\n\n\t[_check](arr, path, errors, stack) {\n\t\tif (Array.isArray(arr))\n\t\t\t(arr[_original] || arr).forEach((a, i) => checkDefinition(a, this.definition, `${path || \"Array\"}[${i}]`, errors, stack))\n\t\telse stackError(errors, this, arr, path)\n\n\t\tcheckAssertions(arr, this, path, errors)\n\t},\n\n\textend(...newParts) {\n\t\treturn extendModel(new ArrayModel(extendDefinition(this.definition, newParts)), this)\n\t}\n})\n\nlet controlMutation = (model, array, key, value, applyMutation, canBeExtended) => {\n\tlet path = `Array[${key}]`\n\tlet isInDef = (+key >= 0 && (canBeExtended || key in array))\n\tif (isInDef) value = checkDefinition(value, model.definition, path, model.errors, [], true)\n\n\tlet testArray = [...array]\n\tapplyMutation(testArray)\n\tcheckAssertions(testArray, model, path)\n\tlet isSuccess = !unstackErrors(model)\n\tif (isSuccess) applyMutation(array, value)\n\treturn isSuccess\n}","import {\n\t_check, _original, _validate, checkAssertions, checkDefinition, extendDefinition, extendModel,\n\tformat, formatDefinition, initModel, Model, stackError, unstackErrors\n} from \"./object-model.js\"\nimport { extend, isFunction, proxifyModel } from \"./helpers.js\"\n\n\nexport default function FunctionModel(...argsDef) {\n\n\tlet model = function (fn = model.default) {\n\t\tif (model[_validate](fn)) {\n\t\t\treturn proxifyModel(fn, model, {\n\t\t\t\tget(fn, key) {\n\t\t\t\t\treturn key === _original ? fn : fn[key]\n\t\t\t\t},\n\n\t\t\t\tapply(fn, ctx, args) {\n\t\t\t\t\tlet def = model.definition\n\n\t\t\t\t\tdef.arguments.forEach((argDef, i) => {\n\t\t\t\t\t\targs[i] = checkDefinition(args[i], argDef, `arguments[${i}]`, model.errors, [], true)\n\t\t\t\t\t})\n\n\t\t\t\t\tcheckAssertions(args, model, \"arguments\")\n\n\t\t\t\t\tlet result\n\t\t\t\t\tif (!model.errors.length) {\n\t\t\t\t\t\tresult = Reflect.apply(fn, ctx, args)\n\t\t\t\t\t\tif (\"return\" in def)\n\t\t\t\t\t\t\tresult = checkDefinition(result, def.return, \"return value\", model.errors, [], true)\n\t\t\t\t\t}\n\t\t\t\t\tunstackErrors(model)\n\t\t\t\t\treturn result\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n\n\textend(model, Function)\n\treturn initModel(model, FunctionModel, { arguments: argsDef })\n}\n\nextend(FunctionModel, Model, {\n\ttoString(stack = []) {\n\t\tlet out = `Function(${this.definition.arguments.map(\n\t\t\targDef => formatDefinition(argDef, [...stack])\n\t\t).join(\", \")})`\n\n\t\tif (\"return\" in this.definition) {\n\t\t\tout += \" => \" + formatDefinition(this.definition.return, stack)\n\t\t}\n\t\treturn out\n\t},\n\n\treturn(def) {\n\t\tthis.definition.return = def\n\t\treturn this\n\t},\n\n\textend(newArgs, newReturns) {\n\t\tlet args = this.definition.arguments,\n\t\t\tmixedArgs = newArgs.map((a, i) => extendDefinition(i in args ? args[i] : [], newArgs[i])),\n\t\t\tmixedReturns = extendDefinition(this.definition.return, newReturns)\n\t\treturn extendModel(new FunctionModel(...mixedArgs).return(mixedReturns), this)\n\t},\n\n\t[_check](f, path, errors) {\n\t\tif (!isFunction(f)) stackError(errors, \"Function\", f, path)\n\t}\n})\n\nFunctionModel.prototype.assert(function numberOfArgs(args) {\n\treturn (args.length > this.definition.arguments.length) ? args : true\n}, function (args) {\n\treturn `expecting ${this.definition.arguments.length} arguments for ${format(this)}, got ${args.length}`\n})","import {\n\t_check, cast, checkAssertions, checkDefinition,\n\textendDefinition, extendModel, format, formatDefinition, Model, stackError\n} from \"./object-model.js\"\nimport { initListModel } from \"./list-model.js\"\nimport { extend, is, isIterable } from \"./helpers.js\"\n\nexport default function MapModel(initialKeyDefinition, initialValueDefinition) {\n\tlet getDef = i => i === 0 ? model.definition.key : model.definition.value,\n\t\tmodel = initListModel(\n\t\t\tMap,\n\t\t\tMapModel,\n\t\t\t{ key: initialKeyDefinition, value: initialValueDefinition },\n\t\t\tit => isIterable(it) ? new Map([...it].map(pair => pair.map((x, i) => cast(x, getDef(i))))) : it,\n\t\t\tmap => new Map(map),\n\t\t\t{\n\t\t\t\t\"set\": [0, 1, getDef],\n\t\t\t\t\"delete\": [],\n\t\t\t\t\"clear\": []\n\t\t\t}\n\t\t)\n\n\treturn model\n}\n\nextend(MapModel, Model, {\n\ttoString(stack) {\n\t\treturn `Map of ${formatDefinition(this.definition.key, stack)} : ${formatDefinition(this.definition.value, stack)}`\n\t},\n\n\t[_check](map, path, errors, stack) {\n\t\tif (is(Map, map)) {\n\t\t\tpath = path || 'Map'\n\t\t\tfor (let [key, value] of map) {\n\t\t\t\tcheckDefinition(key, this.definition.key, `${path} key`, errors, stack)\n\t\t\t\tcheckDefinition(value, this.definition.value, `${path}[${format(key)}]`, errors, stack)\n\t\t\t}\n\t\t} else stackError(errors, this, map, path)\n\n\t\tcheckAssertions(map, this, path, errors)\n\t},\n\n\textend(keyParts, valueParts) {\n\t\treturn extendModel(new MapModel(\n\t\t\textendDefinition(this.definition.key, keyParts),\n\t\t\textendDefinition(this.definition.value, valueParts)\n\t\t), this)\n\t}\n})","import {\n\t_check, cast, checkAssertions, checkDefinition,\n\textendDefinition, extendModel, formatDefinition, Model, stackError\n} from \"./object-model.js\"\nimport { initListModel } from \"./list-model.js\"\nimport { extend, is, isIterable } from \"./helpers.js\"\n\nexport default function SetModel(initialDefinition) {\n\tlet model = initListModel(\n\t\tSet,\n\t\tSetModel,\n\t\tinitialDefinition,\n\t\tit => isIterable(it) ? new Set([...it].map(val => cast(val, model.definition))) : it,\n\t\tset => new Set(set),\n\t\t{\n\t\t\t\"add\": [0, 0],\n\t\t\t\"delete\": [],\n\t\t\t\"clear\": []\n\t\t}\n\t)\n\n\treturn model\n}\n\nextend(SetModel, Model, {\n\ttoString(stack) {\n\t\treturn \"Set of \" + formatDefinition(this.definition, stack)\n\t},\n\n\t[_check](set, path, errors, stack) {\n\t\tif (is(Set, set)) {\n\t\t\tfor (let item of set.values()) {\n\t\t\t\tcheckDefinition(item, this.definition, `${path || \"Set\"} value`, errors, stack)\n\t\t\t}\n\t\t} else stackError(errors, this, set, path)\n\t\tcheckAssertions(set, this, path, errors)\n\t},\n\n\textend(...newParts) {\n\t\treturn extendModel(new SetModel(extendDefinition(this.definition, newParts)), this)\n\t}\n})"],"names":["getProto","Object","getPrototypeOf","setProto","setPrototypeOf","has","o","prop","hasOwnProperty","is","Constructor","obj","isFunction","f","isObject","isPlainObject","prototype","isIterable","x","Symbol","iterator","proxifyFn","fn","apply","Proxy","proxifyModel","val","model","traps","assign","merge","target","src","key","define","value","enumerable","defineProperty","writable","configurable","extend","child","parent","props","create","constructor","_check","_validate","_original","SKIP_VALIDATE","initModel","def","setConstructor","definition","assertions","name","extendModel","newProps","push","stackError","errors","expected","received","path","message","unstackErrors","collector","errorCollector","nbErrors","length","map","err","concat","d","format","join","toString","call","match","bettertypeof","isModelInstance","i","Model","parseDefinition","keys","Array","isArray","undefined","formatDefinition","stack","parts","extendDefinition","newParts","reduce","ext","filter","index","self","indexOf","checkDefinition","shouldCast","indexFound","cast","formatPath","some","part","checkDefinitionPart","RegExp","test","Number","Date","isNaN","checkAssertions","assertion","result","onFail","description","assertionResult","includes","String","unshift","Map","Set","item","indent","repeat","slice","controlMutation","privateAccess","applyMutation","newPath","isPrivate","conventionForPrivate","isConstant","conventionForConstant","isOwnProperty","initialPropDescriptor","getOwnPropertyDescriptor","cannot","msg","defNode","BasicModel","suitableModels","console","warn","getProxy","[object Object]","Reflect","get","defPart","ctx","args","grantPrivateAccess","set","deleteProperty","ownKeys","descriptor","params","ObjectModel","default","mode","this","parentClass","toUpperCase","failed","initialErrorCollector","e","TypeError","replace","proto","defaults","newAssertions","submodel","defaultTo","initListModel","base","init","clone","mutators","otherTraps","list","l","begin","end","getArgDef","argDef","testingClone","ArrayModel","initialDefinition","a","arg","copyWithin","fill","pop","reverse","shift","sort","splice","arr","v","forEach","array","canBeExtended","testArray","isSuccess","FunctionModel","argsDef","arguments","return","Function","MapModel","initialKeyDefinition","initialValueDefinition","getDef","it","pair","delete","clear","SetModel","add","out","newArgs","newReturns","mixedArgs","mixedReturns","assert","keyParts","valueParts","values"],"mappings":"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"}